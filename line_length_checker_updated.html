<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>65æ–‡å­—è¡Œé•·ãƒã‚§ãƒƒã‚«ãƒ¼</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #007acc;
            color: white;
        }
        .btn-primary:hover {
            background-color: #005999;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .input-section {
            margin-bottom: 30px;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
            box-sizing: border-box;
        }
        .output-section {
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: #fafafa;
            min-height: 200px;
        }
        .line-container {
            display: flex;
            align-items: flex-start;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .line-number {
            min-width: 40px;
            color: #666;
            font-size: 12px;
            margin-right: 10px;
            text-align: right;
            padding-top: 2px;
        }
        .line-content {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            word-wrap: break-word;
            padding: 2px 5px;
            border-radius: 3px;
            position: relative;
            min-height: 20px;
            cursor: text;
            white-space: pre-wrap;
            outline: none;
            border: 1px solid transparent;
        }
        .line-content:hover {
            border-color: #ccc;
        }
        .line-content:focus {
            border-color: #007acc;
            box-shadow: 0 0 3px rgba(0,122,204,0.3);
        }
        .line-content .char {
            position: relative;
        }
        .line-content .char-65 {
            background-color: #ffcc00;
            color: #cc6600;
            font-weight: bold;
            border-radius: 2px;
            position: relative;
        }
        .line-content .char-65::after {
            content: 'â”‚';
            position: absolute;
            right: -1px;
            top: -2px;
            color: #cc6600;
            font-weight: bold;
            font-size: 16px;
        }
        .line-content .punctuation {
            background-color: #e6f3ff;
            color: #0066cc;
            font-weight: bold;
            border-radius: 2px;
            padding: 0 1px;
        }
        .line-count {
            min-width: 60px;
            font-size: 12px;
            margin-left: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
        }
        .line-normal {
            background: #e8f5e8;
            color: #2d5a2d;
        }
        .line-over {
            background: #ffe6e6;
            color: #cc0000;
        }
        .line-normal .line-content {
            background: #f0f8f0;
        }
        .line-over .line-content {
            background: #fff0f0;
        }
        .stats {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4f8;
            border-radius: 4px;
            font-size: 14px;
        }
        .warning {
            color: #cc0000;
            font-weight: bold;
        }
        .info {
            color: #666;
            font-size: 12px;
            margin-top: 10px;
        }
        .legend {
            margin-top: 15px;
            font-size: 12px;
            color: #666;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 14px;
            border-radius: 2px;
            display: inline-block;
        }
        .legend-65 {
            background-color: #ffcc00;
        }
        .legend-punctuation {
            background-color: #e6f3ff;
        }
        .ruler {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }
        .ruler-line {
            letter-spacing: 0;
        }
    </style>
</head>
<body>
            <div class="container">
        <h1 id="title">65æ–‡å­—è¡Œé•·ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
        
        <div class="input-section">
            <h3>ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š</h3>
            <div class="controls">
                <label for="charLimit" style="display: flex; align-items: center; gap: 5px; margin-right: 15px;">
                    <span>æ–‡å­—æ•°ä¸Šé™:</span>
                    <input type="number" id="charLimit" value="65" min="1" max="200" style="width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 3px;">
                </label>
                <button class="btn btn-primary" onclick="removeEmptyLines()">ç©ºç™½è¡Œå‰Šé™¤</button>
                <button class="btn btn-secondary" id="undoBtn" onclick="undo()" disabled>å…ƒã«æˆ»ã™ (Ctrl+Z)</button>
                <button class="btn btn-secondary" id="redoBtn" onclick="redo()" disabled>ã‚„ã‚Šç›´ã— (Ctrl+Y)</button>
            </div>
            <textarea id="textInput" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ”¹è¡Œã¯æ‰‹å‹•ã§è¡Œã£ã¦ãã ã•ã„ã€‚"></textarea>
        </div>
        
        <div class="output-section">
            <h3>è¡Œåˆ¥æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯çµæœï¼ˆç·¨é›†å¯èƒ½ï¼‰ï¼š</h3>
            <div class="ruler">
                <div class="ruler-line">1234567890123456789012345678901234567890123456789012345678901234567890</div>
                <div class="ruler-line">         1         2         3         4         5         6    65</div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color legend-65"></span>
                    <span id="legendBoundary">65æ–‡å­—ç›®ï¼ˆå¢ƒç•Œï¼‰</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color legend-punctuation"></span>
                    <span>å¥èª­ç‚¹ãƒ»åŒºåˆ‡ã‚Šæ–‡å­—ï¼ˆæ”¹è¡Œç›®å®‰ï¼‰</span>
                </div>
                <div class="legend-item">
                    <span>ğŸ’¡ å„è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç›´æ¥ç·¨é›†ãƒ»æ”¹è¡Œã§ãã¾ã™</span>
                </div>
            </div>
            <div id="output">
                <div class="info">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å„è¡Œã®æ–‡å­—æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
            </div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div id="totalLines">ç·è¡Œæ•°: 0</div>
            <div id="overLines">65æ–‡å­—è¶…éè¡Œ: 0</div>
            <div id="maxLength">æœ€å¤§è¡Œæ–‡å­—æ•°: 0</div>
        </div>
    </div>

    <script>
        const textInput = document.getElementById('textInput');
        const output = document.getElementById('output');
        const stats = document.getElementById('stats');
        const totalLines = document.getElementById('totalLines');
        const overLines = document.getElementById('overLines');
        const maxLength = document.getElementById('maxLength');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');

        const charLimitInput = document.getElementById('charLimit');
        const title = document.getElementById('title');
        const legendBoundary = document.getElementById('legendBoundary');

        // æ–‡å­—æ•°ä¸Šé™ã®å¤‰æ›´ç›£è¦–
        charLimitInput.addEventListener('input', function() {
            const limit = parseInt(this.value) || 65;
            title.textContent = `${limit}æ–‡å­—è¡Œé•·ãƒã‚§ãƒƒã‚«ãƒ¼`;
            legendBoundary.textContent = `${limit}æ–‡å­—ç›®ï¼ˆå¢ƒç•Œï¼‰`;
            updateOutput();
        });

        // å¥èª­ç‚¹ãƒ»åŒºåˆ‡ã‚Šæ–‡å­—ã®å®šç¾©
        const punctuationChars = /[ã€ã€‚ï¼Œï¼,;:ï¼šï¼›ã€Œã€ã€ã€ï¼ˆï¼‰()ï¼»ï¼½ã€ã€‘ã€”ã€•ã€ˆã€‰ã€Šã€‹ã€œï½ãƒ»ï¼!ï¼Ÿ?.]/;

        // UNDO/REDOç”¨ã®å±¥æ­´
        let history = [];
        let historyIndex = -1;
        let isUpdatingFromHistory = false;

        function addToHistory(text) {
            if (isUpdatingFromHistory) return;
            
            // ç¾åœ¨ã®ä½ç½®ä»¥é™ã®å±¥æ­´ã‚’å‰Šé™¤
            history = history.slice(0, historyIndex + 1);
            
            // æ–°ã—ã„çŠ¶æ…‹ã‚’è¿½åŠ 
            history.push(text);
            historyIndex = history.length - 1;
            
            // å±¥æ­´ã®ä¸Šé™ï¼ˆ100é …ç›®ï¼‰
            if (history.length > 100) {
                history.shift();
                historyIndex--;
            }
            
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                isUpdatingFromHistory = true;
                textInput.value = history[historyIndex];
                updateOutput();
                updateUndoRedoButtons();
                isUpdatingFromHistory = false;
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                isUpdatingFromHistory = true;
                textInput.value = history[historyIndex];
                updateOutput();
                updateUndoRedoButtons();
                isUpdatingFromHistory = false;
            }
        }

        function removeEmptyLines() {
            const currentText = textInput.value;
            const lines = currentText.split('\n');
            const filteredLines = lines.filter(line => line.trim() !== '');
            const newText = filteredLines.join('\n');
            
            if (newText !== currentText) {
                textInput.value = newText;
                addToHistory(newText);
                updateOutput();
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                } else if (e.key === 'y' || (e.key === 'z' && e.shiftKey)) {
                    e.preventDefault();
                    redo();
                }
            }
        });

        function updateOutput() {
            const text = textInput.value;
            const charLimit = parseInt(charLimitInput.value) || 65;
            
            if (text.trim() === '') {
                output.innerHTML = '<div class="info">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã™ã‚‹ã¨ã€å„è¡Œã®æ–‡å­—æ•°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>';
                stats.style.display = 'none';
                return;
            }

            const lines = text.split('\n');
            let overCount = 0;
            let maxLen = 0;
            
            let html = '';
            
            lines.forEach((line, index) => {
                const length = line.length;
                const isOver = length > charLimit;
                
                if (isOver) overCount++;
                if (length > maxLen) maxLen = length;
                
                const lineClass = isOver ? 'line-over' : 'line-normal';
                const countClass = isOver ? 'line-over' : 'line-normal';
                
                // å„æ–‡å­—ã«ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨
                let formattedLine = '';
                if (line.length === 0) {
                    formattedLine = '';
                } else {
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        let charClass = 'char';
                        
                        // å¥èª­ç‚¹ãƒ»åŒºåˆ‡ã‚Šæ–‡å­—ã®ãƒã‚§ãƒƒã‚¯
                        if (punctuationChars.test(char)) {
                            charClass += ' punctuation';
                        }
                        
                        // æ–‡å­—æ•°ä¸Šé™ç›®ã®ãƒã‚§ãƒƒã‚¯
                        if (i === charLimit) {
                            charClass += ' char-65';
                        }
                        
                        formattedLine += `<span class="${charClass}">${char}</span>`;
                    }
                }
                
                html += `
                    <div class="line-container ${lineClass}">
                        <div class="line-number">${index + 1}</div>
                        <div class="line-content" contenteditable="true" data-line="${index}" spellcheck="false">${formattedLine}</div>
                        <div class="line-count ${countClass}">${length}æ–‡å­—</div>
                    </div>
                `;
            });
            
            output.innerHTML = html;
            
            // ç·¨é›†å¯èƒ½ã‚¨ãƒªã‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            document.querySelectorAll('.line-content[contenteditable="true"]').forEach(element => {
                element.addEventListener('input', handleLineEdit);
                element.addEventListener('keydown', handleKeyDown);
            });
            
            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
            totalLines.textContent = `ç·è¡Œæ•°: ${lines.length}`;
            overLines.innerHTML = `${charLimit}æ–‡å­—è¶…éè¡Œ: ${overCount}` + (overCount > 0 ? ' <span class="warning">âš ï¸</span>' : '');
            maxLength.textContent = `æœ€å¤§è¡Œæ–‡å­—æ•°: ${maxLen}`;
            stats.style.display = 'block';
        }

        function handleLineEdit(event) {
            const lineIndex = parseInt(event.target.dataset.line);
            const newContent = event.target.textContent;
            
            // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            // å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const lines = textInput.value.split('\n');
            lines[lineIndex] = newContent;
            const newText = lines.join('\n');
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°
            textInput.value = newText;
            addToHistory(newText);
            
            // è¡¨ç¤ºã‚’æ›´æ–°
            updateOutput();
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            window.scrollTo(0, scrollTop);
            
            // ç·¨é›†ä¸­ã®è¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æˆ»ã™
            setTimeout(() => {
                const editingLine = document.querySelector(`[data-line="${lineIndex}"]`);
                if (editingLine && document.activeElement !== editingLine) {
                    editingLine.focus();
                }
            }, 10);
        }

        function handleKeyDown(event) {
            const lineIndex = parseInt(event.target.dataset.line);
            const lines = textInput.value.split('\n');
            
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // ç¾åœ¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’ä¿å­˜
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’æ­£ç¢ºã«å–å¾—
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦ä½ç½®ã‚’è¨ˆç®—
                let cursorPos = 0;
                const walker = document.createTreeWalker(
                    event.target,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let currentNode;
                while (currentNode = walker.nextNode()) {
                    if (currentNode === range.startContainer) {
                        cursorPos += range.startOffset;
                        break;
                    } else {
                        cursorPos += currentNode.textContent.length;
                    }
                }
                
                // ç¾åœ¨ã®è¡Œã®å†…å®¹ã‚’å–å¾—ï¼ˆHTMLã‚¿ã‚°ã‚’é™¤å»ï¼‰
                const currentLine = event.target.textContent;
                
                // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã§åˆ†å‰²
                const beforeCursor = currentLine.substring(0, cursorPos);
                const afterCursor = currentLine.substring(cursorPos);
                
                // è¡Œã‚’åˆ†å‰²
                lines[lineIndex] = beforeCursor;
                lines.splice(lineIndex + 1, 0, afterCursor);
                
                // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°
                const newText = lines.join('\n');
                textInput.value = newText;
                addToHistory(newText);
                
                // è¡¨ç¤ºã‚’æ›´æ–°
                updateOutput();
                
                // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
                window.scrollTo(0, scrollTop);
                
                // æ¬¡ã®è¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
                setTimeout(() => {
                    const nextLine = document.querySelector(`[data-line="${lineIndex + 1}"]`);
                    if (nextLine) {
                        nextLine.focus();
                        // ã‚«ãƒ¼ã‚½ãƒ«ã‚’å…ˆé ­ã«ç§»å‹•
                        const range = document.createRange();
                        const sel = window.getSelection();
                        if (nextLine.firstChild) {
                            range.setStart(nextLine.firstChild, 0);
                        } else {
                            range.setStart(nextLine, 0);
                        }
                        range.collapse(true);
                        sel.removeAllRanges();
                        sel.addRange(range);
                    }
                }, 10);
            } else if (event.key === 'Backspace') {
                // ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã®å‡¦ç†
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                
                // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œã®å…ˆé ­ã«ã‚ã‚‹å ´åˆ
                if (range.startOffset === 0 && range.collapsed) {
                    // æœ€åˆã®è¡Œã§ãªã‘ã‚Œã°ã€å‰ã®è¡Œã¨çµåˆ
                    if (lineIndex > 0) {
                        event.preventDefault();
                        
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const currentLine = event.target.textContent;
                        const previousLine = lines[lineIndex - 1];
                        const cursorPosition = previousLine.length; // å‰ã®è¡Œã®æœ«å°¾ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’é…ç½®
                        
                        // å‰ã®è¡Œã¨ç¾åœ¨ã®è¡Œã‚’çµåˆ
                        lines[lineIndex - 1] = previousLine + currentLine;
                        lines.splice(lineIndex, 1);
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°
                        const newText = lines.join('\n');
                        textInput.value = newText;
                        addToHistory(newText);
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        updateOutput();
                        
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
                        window.scrollTo(0, scrollTop);
                        
                        // çµåˆã•ã‚ŒãŸè¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¨­å®š
                        setTimeout(() => {
                            const mergedLine = document.querySelector(`[data-line="${lineIndex - 1}"]`);
                            if (mergedLine) {
                                mergedLine.focus();
                                
                                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’çµåˆç‚¹ã«ç§»å‹•
                                const range = document.createRange();
                                const sel = window.getSelection();
                                
                                // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦ä½ç½®ã‚’è¨­å®š
                                let textNode = mergedLine.firstChild;
                                let currentPos = 0;
                                
                                while (textNode && currentPos < cursorPosition) {
                                    if (textNode.nodeType === Node.TEXT_NODE) {
                                        if (currentPos + textNode.textContent.length >= cursorPosition) {
                                            range.setStart(textNode, cursorPosition - currentPos);
                                            break;
                                        }
                                        currentPos += textNode.textContent.length;
                                    }
                                    textNode = textNode.nextSibling;
                                }
                                
                                if (textNode) {
                                    range.collapse(true);
                                    sel.removeAllRanges();
                                    sel.addRange(range);
                                }
                            }
                        }, 10);
                    }
                } else {
                    // é€šå¸¸ã®ãƒãƒƒã‚¯ã‚¹ãƒšãƒ¼ã‚¹å‡¦ç†
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    requestAnimationFrame(() => {
                        window.scrollTo(0, scrollTop);
                    });
                }
            } else if (event.key === 'Delete') {
                // Deleteã‚­ãƒ¼ã®å‡¦ç†
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const currentLine = event.target.textContent;
                
                // ã‚«ãƒ¼ã‚½ãƒ«ãŒè¡Œã®æœ«å°¾ã«ã‚ã‚‹å ´åˆ
                if (range.startOffset === currentLine.length && range.collapsed) {
                    // æœ€å¾Œã®è¡Œã§ãªã‘ã‚Œã°ã€æ¬¡ã®è¡Œã¨çµåˆ
                    if (lineIndex < lines.length - 1) {
                        event.preventDefault();
                        
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                        const nextLine = lines[lineIndex + 1];
                        const cursorPosition = currentLine.length; // ç¾åœ¨ã®è¡Œã®æœ«å°¾ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’é…ç½®
                        
                        // ç¾åœ¨ã®è¡Œã¨æ¬¡ã®è¡Œã‚’çµåˆ
                        lines[lineIndex] = currentLine + nextLine;
                        lines.splice(lineIndex + 1, 1);
                        
                        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’æ›´æ–°
                        const newText = lines.join('\n');
                        textInput.value = newText;
                        addToHistory(newText);
                        
                        // è¡¨ç¤ºã‚’æ›´æ–°
                        updateOutput();
                        
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’å¾©å…ƒ
                        window.scrollTo(0, scrollTop);
                        
                        // çµåˆã•ã‚ŒãŸè¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’è¨­å®š
                        setTimeout(() => {
                            const mergedLine = document.querySelector(`[data-line="${lineIndex}"]`);
                            if (mergedLine) {
                                mergedLine.focus();
                                
                                // ã‚«ãƒ¼ã‚½ãƒ«ã‚’çµåˆç‚¹ã«ç§»å‹•
                                const range = document.createRange();
                                const sel = window.getSelection();
                                
                                // ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦ä½ç½®ã‚’è¨­å®š
                                let textNode = mergedLine.firstChild;
                                let currentPos = 0;
                                
                                while (textNode && currentPos < cursorPosition) {
                                    if (textNode.nodeType === Node.TEXT_NODE) {
                                        if (currentPos + textNode.textContent.length >= cursorPosition) {
                                            range.setStart(textNode, cursorPosition - currentPos);
                                            break;
                                        }
                                        currentPos += textNode.textContent.length;
                                    }
                                    textNode = textNode.nextSibling;
                                }
                                
                                if (textNode) {
                                    range.collapse(true);
                                    sel.removeAllRanges();
                                    sel.addRange(range);
                                }
                            }
                        }, 10);
                    }
                } else {
                    // é€šå¸¸ã®Deleteå‡¦ç†
                    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    requestAnimationFrame(() => {
                        window.scrollTo(0, scrollTop);
                    });
                }
            }
        }

        textInput.addEventListener('input', function() {
            addToHistory(textInput.value);
            updateOutput();
        });
        textInput.addEventListener('keyup', updateOutput);
        textInput.addEventListener('paste', () => {
            setTimeout(() => {
                addToHistory(textInput.value);
                updateOutput();
            }, 10);
        });

        // åˆæœŸåŒ–
        addToHistory('');
        updateOutput();
    </script>
</body>
</html>