<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subtitle Line Breaker</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .logo {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
    }
    .logo img {
      height: 40px;
      opacity: 0.8;
    }
    h1 {
      margin-top: 60px;
    }
    textarea {
      width: 90%;
      max-width: 800px;
      height: 150px;
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      line-height: 1.5;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    pre {
      white-space: pre-wrap;
      background: #f1f1f1;
      padding: 10px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      font-size: 16px;
      position: relative;
    }
    .copy-button {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #28a745;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="ツールロゴ" />
  </div>
  <h1>Subtitle Line Breaker</h1>
  <textarea id="inputText" placeholder="Enter your text here..."></textarea>
  <input type="number" id="maxLength" placeholder="Max characters per line" value="70" style="margin-bottom: 10px; padding: 5px; font-size: 16px; width: 200px;" />
  <br />
  <button onclick="formatText()">整形する</button>
  <pre id="outputText"><button class="copy-button" onclick="copyToClipboard()">Copy</button></pre>

  <script>
   
function formatText() {
  const input = document.getElementById("inputText").value;
  const maxLength = parseInt(document.getElementById("maxLength").value);

  const result = [];
  const sentences = input.match(/[^.!?。]+[.!?。]*/g) || [];

  sentences.forEach(sentence => {
    sentence = sentence.trim();
    if (!sentence) return;

    const words = sentence.split(/(\s+)/).filter(w => w.length > 0);

    let line = "";
    let insideQuotes = false; // クォーテーション内フラグ

    for (let i = 0; i < words.length; i++) {
      let word = words[i];

      // クォーテーションの開始・終了を検知
      // 半角ダブルクォーテーション " と 全角ダブルクォーテーション ”
      const quotes = ['"', '”'];
      for (const q of quotes) {
        // wordの中にクォーテーションがあれば状態を反転
        // ただしword内に複数あれば回数分反転する
        let count = (word.split(q).length - 1);
        if (count % 2 === 1) {
          insideQuotes = !insideQuotes;
        }
      }

      // 連続句読点の判定
      const isConsecutivePunct = /\.{2,}|、{2,}|。{2,}/.test(word);

      // クォーテーション内は改行判定しない（例：ピリオドがあっても改行しない）
      // 連続句読点も改行しない

      // 改行判定するのは、insideQuotes==falseかつ連続句読点でない場合のみ
      const testLine = line + word;
      if (!insideQuotes && !isConsecutivePunct && testLine.length > maxLength) {
        if (line.trim()) result.push(line.trim());
        line = word.trimStart();
      } else {
        line += word;
      }
    }

    if (line.trim()) result.push(line.trim());
  });

  document.getElementById("outputText").innerText = result.join("\n");
}




    function copyToClipboard() {
      const text = document.getElementById("outputText").innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("Copied to clipboard!");
      });
    }
  </script>
</body>
</html>
